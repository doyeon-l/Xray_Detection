{% extends "base.html" %}

{% block title %}ë¶„ë¥˜ ê²°ê³¼ ëª©ë¡{% endblock %}

{% block head %}
<style>
    /* ì •ë ¬ ê°€ëŠ¥í•œ í…Œì´ë¸” í—¤ë”ì— ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½ */
    .sortable { cursor: pointer; }
    .sortable:hover { background-color: #f2f2f2; }
    /* ì¬ë¶„ë¥˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .reclassify-btn { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; white-space: nowrap;}  /* 20250813 ì´ë„ì—° ìˆ˜ì • (white-space: nowrap; ì¶”ê°€) */
    .reclassify-btn:hover { opacity: 0.8; }
    .btn-to-good { background-color: #28a745; color: white; }
    .btn-to-bad { background-color: #dc3545; color: white; }
    /* ë©”ëª¨ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .note-btn { padding: 3px 6px; font-size: 0.8rem; background-color: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;}
    .note-btn:hover { background-color: #5a6268; }
    .note-text { font-size: 0.9em; color: #555; }
</style>
{% endblock %}

{% block content %}
<div class="list-section">
  <h2 class=" list_title">ë¶„ë¥˜ ì´ë¯¸ì§€ ëª©ë¡</h2>
  
  <div class="controls">
    ê¸°ì¤€ì¼: <input type="text" id="from_date" readonly> ~ <input type="text" id="to_date" readonly>
    <select id="class_filter"><option value=""> ì „ì²´</option><option value="1">GOOD</option><option value="0">BAD</option></select>
    &nbsp;íŒŒì¼ëª…: <input type="text" id="search_term" placeholder="ê²€ìƒ‰í•  íŒŒì¼ëª… ì…ë ¥...">
    <button id="search_btn">ê²€ìƒ‰</button>
    <button id="delete-btn">ì„ íƒ ì‚­ì œ</button>
    <a href="#" id="export_btn" class="export-btn">CSVë¡œ ë‚´ë³´ë‚´ê¸°</a>
  </div>

  <div id="upload_modal">
    <h3>ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
    ê¸°ì¤€ì¼:
    <input type="text" id="upload_std_date" readonly>
    <input type="file" id="upload_files" multiple>
    <button id="confirm_upload">ì—…ë¡œë“œ</button>
  </div>
  
  <br/>
  <div>ì´ ê±´ìˆ˜: <span id="total_count">0</span></div>
  <div id="list-container">
    <table>
        <thead>
        <tr>
            <th><input type="checkbox" id="check_all"></th>
            <th>ì´ë¯¸ì§€</th>
            <th class="sortable" data-column="org_image_name"><span>íŒŒì¼ëª…</span><span class="sort-icon"></span></th>
            <th class="sortable" data-column="std_date"><span>ê²€ì¶œ ê¸°ì¤€ì¼</span><span class="sort-icon"></span></th>
            <th class="sortable" data-column="yolo_class"><span>ë¶ˆëŸ‰ ì—¬ë¶€</span><span class="sort-icon"></span></th>
            <th class="sortable" data-column="created_at"><span>ì—…ë¡œë“œ ì¼ì‹œ</span><span class="sort-icon"></span></th>            
            <th>ë©”ëª¨</th>
            <th>ì¬ë¶„ë¥˜ ì—¬ë¶€</th>  <!-- ì—´ ì¶”ê°€ -->
            <th>ì¬ë¶„ë¥˜</th>
            <th>ìˆ˜ì •ì</th>
            <th>ìˆ˜ì •ì¼ì‹œ</th>
        </tr>
        </thead>
        <tbody id="result_body"></tbody>
    </table>
  </div>
</div>
  <div id="image-modal" style="display:none;"><img id="modal-img" src="" /></div>

  <script>
    $(function() {
      // --- ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ ---
      let sortBy = 'created_at';
      let sortOrder = 'DESC';

      // --- ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™” ---
      const today = new Date();
      const aMonthAgo = new Date();
      aMonthAgo.setMonth(today.getMonth() - 1);

      $("#from_date, #upload_std_date").datepicker({ dateFormat: 'yy-mm-dd', maxDate: 0 });
      $("#to_date").datepicker({ dateFormat: 'yy-mm-dd', maxDate: 0 });
      
      $("#from_date").datepicker("setDate", aMonthAgo);
      $("#to_date").datepicker("setDate", today);
      $("#upload_std_date").datepicker("setDate", today);

      // --- ë°ì´í„° ë¡œë“œ ë° í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ ---
      function loadList() {
        const params = {
          from_date: $('#from_date').val().replace(/-/g, ''),
          to_date: $('#to_date').val().replace(/-/g, ''),
          yolo_class: $('#class_filter').val(),
          search_term: $('#search_term').val(),
          sort_by: sortBy,
          sort_order: sortOrder
        };

        $.get('/api/list', params, function(data) {
          $('#result_body').empty();
          $('#total_count').text(data.length);
          $('#export_btn').attr('href', '/api/export?' + $.param(params));

          $.each(data, function(_, row) {
            const date = row.std_date;
            const formattedDate = `${date.substring(0,4)}-${date.substring(4,6)}-${date.substring(6,8)}`;
            
            let reclassifyBtn = (row.yolo_class == '1') ?
                // 20250813 ì´ë„ì—° ìˆ˜ì • (ë¶ˆëŸ‰/ì •ìƒìœ¼ë¡œ ë³€ê²½ -> ë¶ˆëŸ‰/ì •ìƒ ì²˜ë¦¬)
                `<button class="reclassify-btn btn-to-bad" data-id="${row.id}" data-name="${row.org_image_name}" data-new-class="0">ë¶ˆëŸ‰ ì²˜ë¦¬</button>` :
                `<button class="reclassify-btn btn-to-good" data-id="${row.id}" data-name="${row.org_image_name}" data-new-class="1">ì •ìƒ ì²˜ë¦¬</button>`;
            
            // is_reclassified ê°’ì— ë”°ë¼ í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (Yes/No)
            const reclassifiedText = row.is_reclassified ? '<span style="color:blue; font-weight:bold;">Yes</span>' : 'No';

            // ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„: ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ìˆëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. 
            // DBì—ì„œ ê²½ë¡œë¥¼ ìˆ˜ì •í–ˆê¸° ë•Œë¬¸ì— ë” ì´ìƒ replaceê°€ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
            const imagePath = `/${row.image_path}`;

            const tr = `
              <tr>
                <td><input type="checkbox" class="row_chk" data-id="${row.id}"></td>
                <td><img src="${imagePath}" class="thumbnail" data-full="${imagePath}"></td>
                <td>${row.org_image_name}</td>
                <td>${formattedDate}</td>
                <td>${row.yolo_class == '1' ? 'GOOD' : '<b style="color:red">BAD</b>'}</td>
                <td>${row.created_at}</td>
                <td>
                  <button class="note-btn" data-id="${row.id}" data-note="${row.note || ''}" aria-label="ë©”ëª¨ ì—´ê¸°">
                    <img src="{{ url_for('static', filename='img/icons/note.png') }}" class="icon-16" alt="">
                  </button>
                  <span class="note-text">${row.note || ''}</span>
                </td>
                <td>${reclassifiedText}</td>
                <td>${reclassifyBtn}</td>
                <td>${row.modified_by || ''}</td>
                <td>${row.modified_at || ''}</td>
              </tr>`;
            $('#result_body').append(tr);
          });
        });
      }
      
      // ìµœì´ˆ ë¡œë“œ
      loadList();

      // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

      // ê²€ìƒ‰ ë²„íŠ¼ ë° Enter í‚¤
      $('#search_btn').click(loadList);
      $('#search_term').on('keypress', e => { if (e.which === 13) loadList(); });

      // ì •ë ¬
      $('.sortable').click(function() {
          const column = $(this).data('column');
          if (sortBy === column) {
              sortOrder = (sortOrder === 'ASC') ? 'DESC' : 'ASC';
          } else {
              sortBy = column;
              sortOrder = 'DESC';
          }

          // 1. ëª¨ë“  í—¤ë”ì—ì„œ ì•„ì´ì½˜ í…ìŠ¤íŠ¸ë¥¼ ì§€ì›ë‹ˆë‹¤.
          $('.sort-icon').text('');
          
          // 2. í˜„ì¬ í´ë¦­ëœ í—¤ë”ì—ë§Œ ì˜¬ë°”ë¥¸ ì•„ì´ì½˜ì„ ì„¤ì •í•©ë‹ˆë‹¤.
          $(this).find('.sort-icon').text(sortOrder === 'ASC' ? ' ğŸ”¼' : ' ğŸ”½');
          
          loadList();
      });

      // ì¬ë¶„ë¥˜ ë²„íŠ¼
      $(document).on('click', '.reclassify-btn', function() {
        const itemId = $(this).data('id');
        const itemName = $(this).data('name');
        const newClass = $(this).data('new-class').toString();
        const actionText = newClass === '1' ? 'ì •ìƒ' : 'ë¶ˆëŸ‰';

        if (confirm(`'${itemName}' íŒŒì¼ì„ '${actionText}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            $.ajax({
                url: '/api/reclassify', type: 'POST', contentType: 'application/json',
                data: JSON.stringify({ id: itemId, new_class: newClass }),
                success: res => {
                    if (res.status === 'success') {
                        alert(`'${itemName}' íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        loadList();
                    } else { alert('ì˜¤ë¥˜: ' + res.message); }
                },
                error: () => alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
            });
        }
      });
      
      $(document).on('click', '.thumbnail', function () {
        const fullSrc = $(this).data('full');
        $('#modal-img').attr('src', fullSrc);
        $('#image-modal').css('display', 'flex').fadeIn();
      });

      $('#image-modal').click(function () {
        $(this).fadeOut();
      });  

      // ë©”ëª¨ ë²„íŠ¼ (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€)
      $(document).on('click', '.note-btn', function() {
        const btn = $(this);
        const itemId = btn.data('id');
        const currentNote = btn.data('note') || ''; // nullì¼ ê²½ìš° ë¹ˆ ë¬¸ìì—´ë¡œ ì²˜ë¦¬
        const newNote = prompt("ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", currentNote);

        if (newNote !== null && newNote !== currentNote) {
            $.ajax({
                url: '/api/update_note',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: itemId, note: newNote }),
                success: function(res) {
                    if(res.status === 'success') {
                        alert("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        btn.data('note', newNote);
                        btn.siblings('.note-text').text(newNote);
                    } else {
                        alert("ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                },
                error: function() {
                    alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }
      });

      // --- ë‚˜ë¨¸ì§€ ê¸°ì¡´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤ ---
      $('#check_all').click(function() {
        $('.row_chk').prop('checked', $(this).is(':checked'));
      });

      $('#delete-btn').click(function() {
        const ids = $('.row_chk:checked').map((_, el) => $(el).data('id')).get();
        if (ids.length == 0) return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");

        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          $.ajax({
            url: '/api/delete',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids }),
            success: loadList
          });
        }
      });
      
      $('#confirm_upload').on('click', function () {
        const files = $('#upload_files')[0].files;
        const stdDate = $('#upload_std_date').val().replace(/-/g, '');

        if (!stdDate) {
          alert('ê¸°ì¤€ì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }

        if (files.length === 0) {
          alert('ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }

        const formData = new FormData();
        formData.append('std_date', stdDate);
        for (let i = 0; i < files.length; i++) {
          formData.append('files', files[i]);
        }

        $.ajax({
          url: '/upload2',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function (response) {
            if (response.status === 'success') {
              alert('ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
              loadList();
            } else {
              alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ');
            }
          },
          error: function (xhr) {
            alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ');
          }
        });
      });

      loadList();
    });
  </script>
{% endblock %}