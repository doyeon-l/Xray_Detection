{% extends "base.html" %}

{% block title %}ë¶„ë¥˜ ê²°ê³¼ ëª©ë¡{% endblock %}

{% block head %}
<style>
    /* ì •ë ¬ ê°€ëŠ¥í•œ í…Œì´ë¸” í—¤ë”ì— ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½ */
    .sortable { cursor: pointer; }
    .sortable:hover { background-color: #f2f2f2; }
    /* ì¬ë¶„ë¥˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .reclassify-btn { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; white-space: nowrap;}  /* 20250813 ì´ë„ì—° ìˆ˜ì • (white-space: nowrap; ì¶”ê°€) */
    .reclassify-btn:hover { opacity: 0.8; }
    .btn-to-good { background-color: #28a745; color: white; }
    .btn-to-bad { background-color: #dc3545; color: white; }
    /* ë©”ëª¨ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .note-btn { padding: 3px 6px; font-size: 0.8rem; background-color: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;}
    .note-btn:hover { background-color: #5a6268; }
    .note-text { font-size: 0.9em; color: #555; }

    /* ğŸš€ [ì‹ ê·œ] XAI ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .xai-btn {
        padding: 4px 8px;
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .xai-btn:hover { background-color: #138496; }
    .xai-btn:disabled { background-color: #ccc; cursor: not-allowed; }

	#image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000;}
    #modal-img { max-width: 90%; max-height: 90%; }
</style>
{% endblock %}

{% block content %}
<div class="list-section">
  <h2 class=" list_title">ë¶„ë¥˜ ì´ë¯¸ì§€ ëª©ë¡</h2>

  <!-- ğŸš€ [ì‹ ê·œ] ì§€ë„/ë¹„ì§€ë„ íƒ­ UI -->
  <div class="tab-container">
      <button class="tab-btn active" data-model="S">ì§€ë„í•™ìŠµ</button>
      <button class="tab-btn" data-model="U">ë¹„ì§€ë„í•™ìŠµ</button>
  </div>
  
<!-- ğŸš€ [ìµœì¢… ìˆ˜ì •] controls divì˜ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ì•„ë˜ì™€ ê°™ì´ ë³€ê²½í•©ë‹ˆë‹¤. -->
  <div class="controls">
    <!-- 1. ì™¼ìª½ ê·¸ë£¹ (ì¡°íšŒ ê¸°ëŠ¥) -->
    <div class="filter-group">
      <span>ê¸°ì¤€ì¼:</span>
      <input type="text" id="from_date" readonly> ~ <input type="text" id="to_date" readonly>
      <select id="class_filter"><option value="">ì „ì²´</option><option value="1">GOOD</option><option value="0">BAD</option></select>
      <select id="anomaly_filter">
          <option value="">ëª¨ë“  ì´ìƒ ì ìˆ˜</option>
          <option value="high">ë†’ì€ ì´ìƒ ì ìˆ˜ë§Œ</option>
      </select>
      <input type="text" id="search_term" placeholder="íŒŒì¼ëª… ê²€ìƒ‰...">
      <button id="search_btn">ê²€ìƒ‰</button>
      <a href="#" id="export_btn" class="export-btn">CSVë¡œ ë‚´ë³´ë‚´ê¸°</a>
    </div>

    <!-- 2. ì˜¤ë¥¸ìª½ ê·¸ë£¹ (ë°ì´í„° ê´€ë¦¬ ê¸°ëŠ¥) -->
    <div class="action-group">
      <span id="reclassified-info" style="font-weight: bold; margin-right: 15px; display: none;"></span>
      <button id="reclassify-selected-btn">ì„ íƒ íŒì • ë°˜ì „</button>
      <button id="delete-btn" class="btn-delete">ì„ íƒ ì‚­ì œ</button>
      <button id="delete-by-date-btn" class="btn-delete">ê¸°ê°„ ì‚­ì œ</button>
      <button id="delete-all-btn" class="btn-delete">ì „ì²´ ì‚­ì œ</button>
    </div>
  </div>

  <div id="upload_modal">
    <h3>ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
    ê¸°ì¤€ì¼:
    <input type="text" id="upload_std_date" readonly>
    <input type="file" id="upload_files" multiple>
    <button id="confirm_upload">ì—…ë¡œë“œ</button>
  </div>
  
  <br/>
  <div>ì´ ê±´ìˆ˜: <span id="total_count">0</span></div>
  <div id="list-container">
    <table>
        <thead>
        <tr>
            <th><input type="checkbox" id="check_all"></th>
            <th>ì´ë¯¸ì§€</th>
            <th class="sortable" data-column="org_image_name"><span>íŒŒì¼ëª…</span><span class="sort-icon"></span></th>

            <!-- ğŸš€ [ì‹ ê·œ] 'ëª¨ë¸' ì»¬ëŸ¼ ì¶”ê°€ -->
            <th>ëª¨ë¸</th>
            
            <!-- ğŸš€ [ìˆ˜ì •] ë„ì›€ë§ ì•„ì´ì½˜ ì¶”ê°€ -->
            <th>íŒì • <i class="fas fa-info-circle help-icon" data-help="prediction"></i></th>
            <th class="sortable unsupervised-only" data-column="anomaly_score"><span>ì´ìƒ ì ìˆ˜</span> <i class="fas fa-info-circle help-icon" data-help="anomaly"></i><span class="sort-icon"></span></th>
            
            <th class="sortable" data-column="created_at"><span>ì—…ë¡œë“œ ì¼ì‹œ</span><span class="sort-icon"></span></th>            
            <th>ë©”ëª¨</th>
            <th>ì¬ë¶„ë¥˜</th>
            <th>ìˆ˜ì •ì</th>
            <th>ìˆ˜ì •ì¼ì‹œ</th>
            
            <!-- ğŸš€ [ìˆ˜ì •] ë„ì›€ë§ ì•„ì´ì½˜ ì¶”ê°€ -->
            <th>XAI <i class="fas fa-info-circle help-icon" data-help="xai"></i></th>
        </tr>
        </thead>
        <tbody id="result_body"></tbody>
    </table>
  </div>

  <!-- ğŸš€ [ì‹ ê·œ] í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ì´ ë Œë”ë§ë  ì˜ì—­ -->
  <div id="pagination-controls"></div>

  <div id="image-modal" style="display:none;"><img id="modal-img" src="" /></div>

  <!-- ğŸš€ [ì‹ ê·œ] ë„ì›€ë§ íŒì˜¤ë²„ HTML êµ¬ì¡° (í‰ì†Œì—ëŠ” ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
  <div id="help-popover">
      <div id="popover-content"></div>
      <!-- <button id="popover-close">&times;</button> -->
  </div>
</div>

  <script>
    $(function() {
      // --- ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜ ---
      let sortBy = 'created_at';
      let sortOrder = 'DESC';
      let currentPage = 1; // ğŸš€ [ì‹ ê·œ] í˜„ì¬ í˜ì´ì§€ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ë³€ìˆ˜
      const itemsPerPage = 20; // í•œ í˜ì´ì§€ì— í‘œì‹œí•  í•­ëª© ìˆ˜
      let currentModelTab = 'S'; // ğŸš€ [ì‹ ê·œ] í˜„ì¬ í™œì„±í™”ëœ íƒ­ì„ ê´€ë¦¬ ('S'ê°€ ê¸°ë³¸)

      // --- ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™” ---
      const today = new Date();
      const aMonthAgo = new Date();
      aMonthAgo.setMonth(today.getMonth() - 1);

      $("#from_date, #upload_std_date").datepicker({ dateFormat: 'yy-mm-dd', maxDate: 0 });
      $("#to_date").datepicker({ dateFormat: 'yy-mm-dd', maxDate: 0 });
      
      $("#from_date").datepicker("setDate", aMonthAgo);
      $("#to_date").datepicker("setDate", today);
      $("#upload_std_date").datepicker("setDate", today);
      $("#from_date, #to_date, #upload_std_date").css('cursor', 'pointer');

      // --- ğŸš€ [ìˆ˜ì •] í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§ í•¨ìˆ˜ ---
      function renderPagination(totalItems) {
          const totalPages = Math.ceil(totalItems / itemsPerPage);
          const controls = $('#pagination-controls').empty();
          if (totalPages <= 1) return; // 1í˜ì´ì§€ ì´í•˜ë©´ ë Œë”ë§ ì•ˆí•¨

          let paginationHtml = '<ul class="pagination">';
          
          // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
          paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage - 1}">ì´ì „</a></li>`;

          // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ (í˜„ì¬ í˜ì´ì§€ ì£¼ë³€ 5ê°œë§Œ í‘œì‹œ)
          let startPage = Math.max(1, currentPage - 2);
          let endPage = Math.min(totalPages, currentPage + 2);

          if (startPage > 1) {
              paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
              if (startPage > 2) paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          for (let i = startPage; i <= endPage; i++) {
              paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
          }
          if (endPage < totalPages) {
              if (endPage < totalPages - 1) paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
              paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
          }

          // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
          paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage + 1}">ë‹¤ìŒ</a></li>`;
          paginationHtml += '</ul>';
          controls.html(paginationHtml);
      }

      // --- ğŸš€ [ìˆ˜ì •] ë°ì´í„° ë¡œë“œ ë° í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ ---
      function loadList(page = 1) {
        currentPage = page;
        const params = {
            from_date: $('#from_date').val().replace(/-/g, ''),
            to_date: $('#to_date').val().replace(/-/g, ''),
            yolo_class: $('#class_filter').val(),
            search_term: $('#search_term').val(),
            model_gb: currentModelTab, // ğŸš€ [ìˆ˜ì •] íƒ­ ìƒíƒœë¥¼ API íŒŒë¼ë¯¸í„°ë¡œ ì „ì†¡
            sort_by: sortBy,
            sort_order: sortOrder,
            page: currentPage,
            limit: itemsPerPage
        };

        $.get('/api/list', params, function(response) {
            const data = response.data;
            const totalItems = response.total;

            $('#result_body').empty();
            $('#total_count').text(totalItems);
            $('#export_btn').attr('href', '/api/export?' + $.param(params));

            let displayData = data;
            if ($('#anomaly_filter').val() === 'high') {
                const anomalyScores = data.map(d => d.anomaly_score).filter(s => s !== null && s !== undefined);
                const threshold = anomalyScores.length > 0 ? anomalyScores.sort((a, b) => b - a)[Math.floor(anomalyScores.length * 0.05)] : 0.1;
                displayData = data.filter(d => d.anomaly_score >= threshold && d.yolo_class == '1');
            }

            $.each(displayData, function(_, row) {
                // ğŸš€ [ìˆ˜ì • 1] ì¬ë¶„ë¥˜ ë²„íŠ¼ì— data-name ì†ì„± ì¶”ê°€
                const reclassifyBtn = (row.yolo_class == '1')
                    ? `<button class="reclassify-btn btn-to-bad" data-id="${row.id}" data-name="${row.org_image_name}" data-new-class="0">ë¶ˆëŸ‰ ì²˜ë¦¬</button>`
                    : `<button class="reclassify-btn btn-to-good" data-id="${row.id}" data-name="${row.org_image_name}" data-new-class="1">ì •ìƒ ì²˜ë¦¬</button>`;

                const anomalyScoreText = (row.anomaly_score != null) ? row.anomaly_score.toFixed(4) : 'N/A';
                const anomalyStyle = (row.anomaly_score > 0.1) ? 'color: red; font-weight: bold;' : '';
                const modelText = row.model_gb === 'S' ? 'ì§€ë„' : (row.model_gb === 'U' ? 'ë¹„ì§€ë„' : 'N/A');

                // ğŸš€ [ìˆ˜ì • 2] í…Œì´ë¸” í–‰(tr)ì— ìˆ˜ì •ì, ìˆ˜ì •ì¼ì‹œ ë°ì´í„° ì…€(td) ì¶”ê°€
                const tr = `
                  <tr>
                    <td><input type="checkbox" class="row_chk" data-id="${row.id}"></td>
                    <td><img src="/${row.image_path}" class="thumbnail" data-full="/${row.image_path}"></td>
                    <td>${row.org_image_name || ''}</td>
                    <td><b>${modelText}</b></td>
                    <td>${Number(row.yolo_class) === 1 ? '<b style="color:blue">GOOD</b>' : '<b style="color:red">BAD</b>'}</td>
                    <td class="unsupervised-only" style="${anomalyStyle}">${anomalyScoreText}</td>

                    <td>${row.created_at || ''}</td>
                    <td>
                      <button class="note-btn" data-id="${row.id}" data-note="${row.note || ''}">ë©”ëª¨</button>
                      <span class="note-text">${row.note || ''}</span>
                    </td>
                    <td>${reclassifyBtn}</td>
                    <td>${row.modified_by || ''}</td>
                    <td>${row.modified_at || ''}</td>
                    <td><button class="xai-btn" data-id="${row.id}">ë³´ê¸°</button></td>
                  </tr>`;
                $('#result_body').append(tr);
            });

            // ğŸš€ [ìˆ˜ì •] í…Œì´ë¸”ì´ ë‹¤ì‹œ ê·¸ë ¤ì§„ í›„, í˜„ì¬ íƒ­ ìƒíƒœì— ë§ê²Œ ì»¬ëŸ¼ì„ ë‹¤ì‹œ ìˆ¨ê¸°ê±°ë‚˜ ë³´ì—¬ì¤ë‹ˆë‹¤.
            if (currentModelTab === 'S') {
                $('.unsupervised-only').hide();
            } else {
                $('.unsupervised-only').show();
            }

            renderPagination(totalItems);
        }).fail(function() {
            alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        });
      }

      // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë°”ì¸ë”© ---
      
      // ìµœì´ˆ ë¡œë“œ
      loadList(1);

      // í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œ 'ì´ìƒ ì ìˆ˜' ì»¬ëŸ¼ì„ ìˆ¨ê¹ë‹ˆë‹¤.
      $('.unsupervised-only').hide();

      // ğŸš€ [ìˆ˜ì •] íƒ­ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      $('.tab-btn').on('click', function() {
          $('.tab-btn').removeClass('active');
          $(this).addClass('active');
          currentModelTab = $(this).data('model');

          const modelName = currentModelTab === 'S' ? 'ì§€ë„í•™ìŠµ' : 'ë¹„ì§€ë„í•™ìŠµ';
          $('#upload-model-indicator').text(`${modelName} ëª¨ë¸ë¡œ ì—…ë¡œë“œ`);

          // ğŸš€ [ìˆ˜ì •] íƒ­ ìƒíƒœì— ë”°ë¼ 'ì´ìƒ ì ìˆ˜' ì»¬ëŸ¼ì„ ì œì–´í•©ë‹ˆë‹¤.
          if (currentModelTab === 'S') {
              $('.unsupervised-only').hide(); // ì§€ë„í•™ìŠµ íƒ­ì´ë©´ ìˆ¨ê¹€
          } else {
              $('.unsupervised-only').show(); // ë¹„ì§€ë„í•™ìŠµ íƒ­ì´ë©´ ë³´ì„
          }
          
          // íƒ­ì„ ë°”ê¾¸ë©´ í•„í„°ëŠ” ì´ˆê¸°í™”í•˜ê³  1í˜ì´ì§€ë¶€í„° ë‹¤ì‹œ ë¡œë“œ
          $('#class_filter').val('');
          $('#anomaly_filter').val('');
          $('#search_term').val('');
          loadList(1);
      });

      // ğŸš€ ê²€ìƒ‰ ì‹œì—ëŠ” í•­ìƒ 1í˜ì´ì§€ë¶€í„° ì¡°íšŒ
      $('#search_btn, #anomaly_filter, #class_filter').on('click change', function() { loadList(1); });
      $('#search_term').on('keypress', e => { if (e.which === 13) loadList(1); });
      
      // ğŸš€ í˜ì´ì§€ë„¤ì´ì…˜ ë§í¬ í´ë¦­ ì´ë²¤íŠ¸
      $(document).on('click', '.pagination a', function(e) {
          e.preventDefault();
          const page = $(this).data('page');
          if (page) {
              loadList(page);
          }
      });

      // í…Œì´ë¸” í—¤ë” ì •ë ¬
      $('.sortable').click(function() {
        const column = $(this).data('column');
        if (sortBy === column) {
            sortOrder = (sortOrder === 'ASC') ? 'DESC' : 'ASC';
        } else {
            sortBy = column;
            sortOrder = 'DESC';
        }
        $('.sort-icon').text('');
        $(this).find('.sort-icon').text(sortOrder === 'ASC' ? ' ğŸ”¼' : ' ğŸ”½');
        loadList(currentPage); // í˜„ì¬ í˜ì´ì§€ì—ì„œ ì •ë ¬
      });

      // --- [í•µì‹¬ ìˆ˜ì •] ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ---
      $('#confirm_upload').on('click', function () {
        const formData = new FormData();
        const files = $('#upload_files')[0].files;
        const stdDate = $('#upload_std_date').val().replace(/-/g, '');

        if (!stdDate) { alert('ê¸°ì¤€ì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
        if (files.length === 0) { alert("ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }

        formData.append('std_date', stdDate);
        // í˜„ì¬ í™œì„±í™”ëœ íƒ­ì˜ ëª¨ë¸ ì¢…ë¥˜ë¥¼ í•¨ê»˜ ì „ì†¡
        formData.append('model_gb', currentModelTab);
        for (let i = 0; i < files.length; i++) { formData.append('files', files[i]); }

        const overlay = $('#upload-progress-overlay');
        const progressBar = $('#progress-bar');
        const progressText = $('#progress-text');

        progressBar.css('width', '0%').text('');
        progressText.text('ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...');
        overlay.css('display', 'flex').hide().fadeIn(200);

        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(evt) {
                    if (evt.lengthComputable) {
                        const percentComplete = Math.round((evt.loaded / evt.total) * 100);
                        progressBar.css('width', percentComplete + '%').text(percentComplete + '%');
                        progressText.text(`ì—…ë¡œë“œ ì¤‘...`);
                    }
                }, false);
                return xhr;
            },
            success: function (response) {
                if (response.status === 'success') {
                    progressText.text('ì—…ë¡œë“œ ì™„ë£Œ!');
                    setTimeout(() => {
                        overlay.fadeOut(300);
                        loadList(1); // ì—…ë¡œë“œ í›„ 1í˜ì´ì§€ë¡œ ì´ë™
                    }, 1000);
                } else {
                    alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ' + response.message);
                    overlay.fadeOut(300);
                }
            },
            error: function () {
                alert('ì—…ë¡œë“œ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                overlay.fadeOut(300);
            }
        });
      });

      // ğŸš€ [ì‹ ê·œ] ì¬ë¶„ë¥˜ ê°œìˆ˜ë¥¼ í™•ì¸í•˜ê³  ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
      function checkReclassifiedCount() {
        $.getJSON('/api/reclassified_count', function(data) {
          const count = data.count;
          const infoSpan = $('#reclassified-info');
          if (count > 0) {
            infoSpan.html(`ì¬ë¶„ë¥˜: <span style="color: #007bff;">${count}</span>ê±´`);
            infoSpan.show();
          } else {
            infoSpan.hide();
          }
        });
      }

      // ğŸš€ [ì‹ ê·œ] ì¬ë¶„ë¥˜ ì‘ì—…ì´ ëë‚  ë•Œë§ˆë‹¤ ê°œìˆ˜ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ë„ë¡ í˜¸ì¶œ ì¶”ê°€
      function reclassifyCompleteHandler() {
        loadList(currentPage);
        $('#check_all').prop('checked', false);
        checkReclassifiedCount(); // ğŸ‘ˆ ê°œìˆ˜ ìƒˆë¡œê³ ì¹¨
      }

      // ê°œë³„ ì¬ë¶„ë¥˜ ë²„íŠ¼
      $(document).on('click', '.reclassify-btn', function() {
        const itemId = $(this).data('id');
        const itemName = $(this).data('name');
        const newClass = $(this).data('new-class').toString();
        const actionText = newClass === '1' ? 'ì •ìƒ' : 'ë¶ˆëŸ‰';

        if (confirm(`'${itemName}' íŒŒì¼ì„ '${actionText}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            $.ajax({
                url: '/api/reclassify', type: 'POST', contentType: 'application/json',
                data: JSON.stringify({ id: itemId, new_class: newClass }),
                success: res => {
                    if (res.status === 'success') {
                        showToast(`'${itemName}' íŒŒì¼ì˜ íŒì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                        reclassifyCompleteHandler(); // ì´ í•¨ìˆ˜ í˜¸ì¶œ í•˜ë‚˜ë¡œ ëª¨ë“  í›„ì† ì²˜ë¦¬ê°€ ëë‚©ë‹ˆë‹¤.
                    } else {
                        // ğŸ’¡ alert() ëŒ€ì‹  showToast()ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                        showToast('ì˜¤ë¥˜: ' + res.message, 'error');
                    }
                },
                // ğŸš€ [ìˆ˜ì •] ì‹¤íŒ¨ í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
                error: () => showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error')
            });
        }
      });
      
      $(document).on('click', '.thumbnail', function () {
        const fullSrc = $(this).data('full');
        $('#modal-img').attr('src', fullSrc);
        $('#image-modal').css('display', 'flex').fadeIn();
      });

      $('#image-modal').click(function () {
        $(this).fadeOut();
      });  

      // ë©”ëª¨ ë²„íŠ¼ (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€)
      $(document).on('click', '.note-btn', function() {
        const btn = $(this);
        const itemId = btn.data('id');
        const currentNote = btn.data('note') || ''; // nullì¼ ê²½ìš° ë¹ˆ ë¬¸ìì—´ë¡œ ì²˜ë¦¬
        const newNote = prompt("ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", currentNote);

        if (newNote !== null && newNote !== currentNote) {
            $.ajax({
                url: '/api/update_note',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: itemId, note: newNote }),
                success: function(res) {
                    if(res.status === 'success') {
                        alert("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        btn.data('note', newNote);
                        btn.siblings('.note-text').text(newNote);
                    } else {
                        alert("ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                },
                error: function() {
                    alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }
      });

      // ğŸš€ [ì‹ ê·œ] ë„ì›€ë§ ë‚´ìš© ì •ì˜
      const helpContent = {
          prediction: {
              title: 'íŒì • (Prediction)',
              text: "ì§€ë„í•™ìŠµ AI ëª¨ë¸ì´ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ 'ì •ìƒ(GOOD)' ë˜ëŠ” 'ë¶ˆëŸ‰(BAD)'ìœ¼ë¡œ ë‚´ë¦° **ìµœì¢… ê²°ë¡ **ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì§ì ‘ 'ì¬ë¶„ë¥˜' ë²„íŠ¼ì„ í†µí•´ ì´ íŒì •ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          },
          anomaly: {
              title: 'ì´ìƒ ì ìˆ˜ (Anomaly Score)',
              text: "ë¹„ì§€ë„í•™ìŠµ AI ëª¨ë¸ì´ ê³„ì‚°í•œ 'ë‚¯ì„¦'ì˜ ì •ë„ì…ë‹ˆë‹¤. ì ìˆ˜ê°€ <strong>ë†’ì„ìˆ˜ë¡</strong> AIê°€ ë³´ê¸°ì— í•™ìŠµëœ ì •ìƒ ì œí’ˆ íŒ¨í„´ê³¼ ë‹¤ë¥´ë‹¤ëŠ” ì˜ë¯¸ì´ë©°, ì•Œë ¤ì§€ì§€ ì•Šì€ ìƒˆë¡œìš´ ìœ í˜•ì˜ ë¶ˆëŸ‰ì¼ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤."
          },
          xai: {
              title: 'XAI (ì„¤ëª… ê°€ëŠ¥í•œ AI)',
              text: "'ë³´ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ AIê°€ ì´ë¯¸ì§€ì˜ ì–´ëŠ ë¶€ë¶„ì„ ë³´ê³  íŒì •ì„ ë‚´ë ¸ëŠ”ì§€ <strong>íˆíŠ¸ë§µ(Heatmap)</strong>ìœ¼ë¡œ ì‹œê°í™”í•˜ì—¬ ë³´ì—¬ì¤ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ AIì˜ íŒë‹¨ ê·¼ê±°ë¥¼ ì´í•´í•˜ê³  ì‹ ë¢°ë„ë¥¼ í‰ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          }
      };

      // ğŸš€ ë„ì›€ë§ ì•„ì´ì½˜ì— ë§ˆìš°ìŠ¤ í˜¸ë²„(mouseover/mouseleave) ì´ë²¤íŠ¸
      let popoverTimeout; // íŒì˜¤ë²„ê°€ ë°”ë¡œ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡ í•˜ê¸° ìœ„í•œ íƒ€ì´ë¨¸ ë³€ìˆ˜

      // ì•„ì´ì½˜ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ
      $(document).on('mouseover', '.help-icon', function(e) {
        clearTimeout(popoverTimeout);
        
        const helpKey = $(this).data('help');
        const content = helpContent[helpKey];
        const popover = $('#help-popover');

        $('#popover-content').html(`<h4>${content.title}</h4><p>${content.text}</p>`);
        
        const iconPos = $(this).offset();
        const popoverWidth = popover.outerWidth();
        const windowWidth = $(window).width();

        // ğŸš€ [í•µì‹¬ ë¡œì§ ì¶”ê°€] íŒì˜¤ë²„ì˜ left ìœ„ì¹˜ë¥¼ ë™ì ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
        let popoverLeft = iconPos.left - (popoverWidth / 2) + ($(this).width() / 2);

        // ë§Œì•½ íŒì˜¤ë²„ê°€ í™”ë©´ ì˜¤ë¥¸ìª½ì„ ë²—ì–´ë‚œë‹¤ë©´, ìœ„ì¹˜ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.
        if (popoverLeft + popoverWidth > windowWidth - 20) { // 20pxì˜ ì—¬ë°±
            popoverLeft = windowWidth - popoverWidth - 20;
        }

        // ë§Œì•½ íŒì˜¤ë²„ê°€ í™”ë©´ ì™¼ìª½ì„ ë²—ì–´ë‚œë‹¤ë©´, ìœ„ì¹˜ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.
        if (popoverLeft < 10) { // 10pxì˜ ì—¬ë°±
            popoverLeft = 10;
        }

        popover.css({
            top: iconPos.top + 25 + 'px',
            left: popoverLeft + 'px' // ê³„ì‚°ëœ left ê°’ì„ ì ìš©í•©ë‹ˆë‹¤.
        }).fadeIn(200);
      });

      // ì•„ì´ì½˜ì—ì„œ ë§ˆìš°ìŠ¤ê°€ ë²—ì–´ë‚¬ì„ ë•Œ
      $(document).on('mouseleave', '.help-icon', function() {
          // ë°”ë¡œ ì‚¬ë¼ì§€ì§€ ì•Šê³ , 0.3ì´ˆì˜ ìœ ì˜ˆ ì‹œê°„ì„ ë‘  (íŒì˜¤ë²„ ìœ„ë¡œ ë§ˆìš°ìŠ¤ë¥¼ ì˜®ê¸¸ ì‹œê°„ì„ ì£¼ê¸° ìœ„í•¨)
          popoverTimeout = setTimeout(function() {
              $('#help-popover').fadeOut(200);
          }, 300);
      });

      // íŒì˜¤ë²„ ì°½ ìì²´ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•ŒëŠ” ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡ ì²˜ë¦¬
      $('#help-popover').on('mouseover', function() {
          clearTimeout(popoverTimeout); // ì‚¬ë¼ì§€ëŠ” íƒ€ì´ë¨¸ ì·¨ì†Œ
      });

      // íŒì˜¤ë²„ ì°½ì—ì„œ ë§ˆìš°ìŠ¤ê°€ ë²—ì–´ë‚˜ë©´ ì¦‰ì‹œ ì‚¬ë¼ì§€ë„ë¡ ì²˜ë¦¬
      $('#help-popover').on('mouseleave', function() {
          $(this).fadeOut(200);
      });

      // --- ë‚˜ë¨¸ì§€ ê¸°ì¡´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤ ---
      $('#check_all').click(function() {
        $('.row_chk').prop('checked', $(this).is(':checked'));
      });

      $('#delete-btn').click(function() {
        const ids = $('.row_chk:checked').map((_, el) => $(el).data('id')).get();
        if (ids.length == 0) return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");

        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          $.ajax({
            url: '/api/delete',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids }),
            success: function(res) { // ğŸ’¡ [í•µì‹¬ ìˆ˜ì •] success ì½œë°± í•¨ìˆ˜ë¥¼ í™•ì¥í•©ë‹ˆë‹¤.
                // 1. ëª©ë¡ì„ 1í˜ì´ì§€ë¡œ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
                loadList(1);
                // 2. 'ì „ì²´ ì„ íƒ' ì²´í¬ë°•ìŠ¤ë¥¼ í•´ì œí•©ë‹ˆë‹¤.
                $('#check_all').prop('checked', false);
            },
            error: function() {
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
          });
        }
      });

      // ğŸš€ [ì‹ ê·œ] ê¸°ê°„ë³„ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      $('#delete-by-date-btn').on('click', function() {
          const fromDate = $('#from_date').val().replace(/-/g, '');
          const toDate = $('#to_date').val().replace(/-/g, '');
          
          if (confirm(`ì •ë§ë¡œ ${fromDate}ë¶€í„° ${toDate}ê¹Œì§€ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
              $.ajax({
                  url: '/api/delete_by_date',
                  type: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify({ from_date: fromDate, to_date: toDate }),
                  success: function(res) {
                      if (res.status === 'success') {
                          alert(`${res.deleted_count}ê±´ì˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                          loadList(1); // 1í˜ì´ì§€ë¡œ ìƒˆë¡œê³ ì¹¨
                      }
                  },
                  error: function() { alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
              });
          }
      });

      // ğŸš€ [ì‹ ê·œ] ì „ì²´ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      $('#delete-all-btn').on('click', function() {
          if (prompt("ëª¨ë“  ë°ì´í„°ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ë ¤ë©´ 'ì „ì²´ì‚­ì œ'ë¥¼ ì…ë ¥í•˜ì„¸ìš”.") === 'ì „ì²´ì‚­ì œ') {
              $.ajax({
                  url: '/api/delete_all',
                  type: 'POST',
                  success: function(res) {
                      if (res.status === 'success') {
                          alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                          loadList(1); // 1í˜ì´ì§€ë¡œ ìƒˆë¡œê³ ì¹¨
                      }
                  },
                  error: function() { alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
              });
          } else {
              alert('ì…ë ¥ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì‘ì—…ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
          }
      });

      // ğŸš€ [ì‹ ê·œ] XAI ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      $(document).on('click', '.xai-btn', function() {
          const btn = $(this);
          const itemId = btn.data('id');
          btn.text('ìƒì„±ì¤‘...').prop('disabled', true);

          $.get(`/api/grad_cam/${itemId}`, function(response) {
              if (response.status === 'success') {
                  $('#modal-img').attr('src', `/${response.xai_path}?t=${new Date().getTime()}`); // ìºì‹œ ë°©ì§€
                  $('#image-modal').css('display', 'flex').fadeIn();
              } else {
                  alert('XAI ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: ' + response.message);
              }
          }).fail(function() {
              alert('ì„œë²„ ì˜¤ë¥˜ë¡œ XAI ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }).always(function() {
              btn.text('ë³´ê¸°').prop('disabled', false);
          });
      });

      // ğŸš€ [ì‹ ê·œ] ì„ íƒ í•­ëª© ì¼ê´„ íŒì • ì „í™˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      $('#reclassify-selected-btn').on('click', function() {
          const checkedRows = $('.row_chk:checked');
          if (checkedRows.length === 0) {
              // ğŸ’¡ alert() ëŒ€ì‹  showToast()ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
              showToast("íŒì •ì„ ì „í™˜í•  í•­ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.", 'error');
              return;
          }

          let itemsToReclassify = [];
          checkedRows.each(function() {
              const row = $(this).closest('tr');
              const id = $(this).data('id');
              const currentStatusText = row.find('td:nth-child(5)').text();
              const currentClass = currentStatusText.includes('GOOD') ? '1' : '0';
              itemsToReclassify.push({
                  id: id,
                  current_class: currentClass
              });
          });

          if (confirm(`${itemsToReclassify.length}ê°œ í•­ëª©ì˜ íŒì •ì„ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              $.ajax({
                  url: '/api/reclassify_batch',
                  type: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify({ items: itemsToReclassify }),
                  success: function(res) {
                      if (res.status === 'success') {
                        showToast(`${itemsToReclassify.length}ê°œ í•­ëª©ì˜ íŒì •ì´ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                        reclassifyCompleteHandler(); // ì´ í•¨ìˆ˜ í˜¸ì¶œ í•˜ë‚˜ë¡œ ëª¨ë“  í›„ì† ì²˜ë¦¬ê°€ ëë‚©ë‹ˆë‹¤.
                      } else {
                        showToast('ì¼ê´„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + res.message, 'error');
                      }
                  },
                  // ğŸš€ [ìˆ˜ì •] ì‹¤íŒ¨ í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
                  error: function() {
                    showToast('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                  }
              });
          }
      });

      // ğŸš€ [ì‹ ê·œ] í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œë„ ê°œìˆ˜ë¥¼ í™•ì¸
      loadList(1);
      checkReclassifiedCount();
    }); // <-- $(function() { ì˜ ë‹«ëŠ” ë¶€ë¶„
  </script>
{% endblock %}