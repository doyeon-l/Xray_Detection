<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ë¶„ë¥˜ ê²°ê³¼ ëª©ë¡</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    .controls { margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .thumbnail { cursor: pointer; width: 60px; height: 60px; object-fit: cover; }    
    #list-container { height: 600px; overflow-y: scroll; border: 1px solid #ccc; }
    #image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
    #modal-img { max-width: 90%; max-height: 90%; }    
  </style>
</head>
<body>
  <h2>ğŸ“‚ ë¶„ë¥˜ ì´ë¯¸ì§€ ëª©ë¡</h2>

  <div class="controls">
    ê¸°ì¤€ì¼: 
    <input type="text" id="from_date" readonly> ~ 
    <input type="text" id="to_date" readonly>
    <select id="class_filter">
      <option value="">ì „ì²´</option>
      <option value="1">GOOD</option>
      <option value="0">BAD</option>
    </select>
    <button id="search_btn">ğŸ” ê²€ìƒ‰</button>
    <button id="delete-btn">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
    <!--<button id="upload_btn">ğŸ“¤ ì—…ë¡œë“œ</button>-->
  </div>
  <div id="upload_modal">
    <h3>ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
    ê¸°ì¤€ì¼: <input type="text" id="upload_std_date" readonly>
    <input type="file" id="upload_files" multiple>
    <button id="confirm_upload">ì—…ë¡œë“œ</button>
  </div>
<br/>
  <div>ì´ ê±´ìˆ˜: <span id="total_count">0</span></div>
  <div id="list-container">
    <table>
        <thead>
        <tr>
            <th><input type="checkbox" id="check_all"></th>
            <th>ì´ë¯¸ì§€</th>
            <th>íŒŒì¼ëª…</th>
            <!--<th>í•™ìŠµ ìœ í˜•</th>-->
            <th>ê²€ì¶œ ê¸°ì¤€ì¼</th>
            <th>ë¶ˆëŸ‰ ì—¬ë¶€</th>
            <th>ë°ì´í„° ì—…ë¡œë“œ ì¼ì‹œ</th>            
        </tr>
        </thead>
        <tbody id="result_body" ></tbody>
    </table>
  </div>

  <div id="image-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
background-color: rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
  <img id="modal-img" src="" style="max-width:90%; max-height:90%;" />
  </div>

  <script>
    $(function() {
      const today = new Date();
      const yesterday = new Date();
      yesterday.setDate(today.getDate() - 1);

      function formatDate(date) {
        return date.toISOString().slice(0,10);
      }

      $("#from_date, #to_date, #upload_std_date").datepicker({
        dateFormat: 'yy-mm-dd',
        maxDate: 0,
        onSelect: function(dateText) {
          /*
          const from = $("#from_date").datepicker('getDate');
          const to = $("#to_date").datepicker('getDate');
          if (from && to) {
            const days = (to - from) / (1000 * 60 * 60 * 24);
            if (days > 31) {
              alert("ìµœëŒ€ ì¡°íšŒ ê¸°ê°„ì€ 1ë‹¬ì…ë‹ˆë‹¤.");
              $("#to_date").datepicker("setDate", from);
            }
          }
          */
        }          
      });

      $("#from_date").datepicker("setDate", yesterday);
      $("#to_date").datepicker("setDate", today);
      $("#upload_std_date").datepicker("setDate", today);

      function loadList() {
        const from = $('#from_date').val().replace(/-/g, '');
        const to = $('#to_date').val().replace(/-/g, '');
        const cls = $('#class_filter').val();

        $.get('/api/list', { std_date: '', yolo_class: cls }, function(data) {
          const filtered = data.filter(item => item.std_date >= from && item.std_date <= to);
          $('#result_body').empty();
          $('#total_count').text(filtered.length);

          $.each(filtered, function(_, row) {
            const format_date = row.std_date;
          
            const formatted_std_date = `${format_date.substring(0,4)}-${format_date.substring(4,6)}-${format_date.substring(6,8)}` ;
          
            const tr = `
              <tr>
                <td><input type="checkbox" class="row_chk" data-id="${row.id}"></td>
                <td><img src="${row.image_path}" class="thumbnail" data-full="${row.image_path}" style="width:60px; height:60px; cursor:pointer;"></td>
                <td>${row.org_image_name}</td>
                <td>${formatted_std_date}</td>
                <td>${row.yolo_class == '1' ? 'GOOD' : '<b style="color:red">BAD</b>'}</td>
                <td>${row.created_at}</td>
              </tr>`;
            $('#result_body').append(tr);
          });
        });
      }

      loadList();

      $('#search_btn').click(function() {
        /*const from = $("#from_date").datepicker('getDate');
        const to = $("#to_date").datepicker('getDate');
        if (from && to) {
            const days = (to - from) / (1000 * 60 * 60 * 24);
            if (days > 31) {
              alert("ìµœëŒ€ ì¡°íšŒ ê¸°ê°„ì€ 1ë‹¬ì…ë‹ˆë‹¤.");
              $("#to_date").datepicker("setDate", from);
            }
        }
      */
        loadList();
      });

      $('#check_all').click(function() {
        $('.row_chk').prop('checked', $(this).is(':checked'));
      });

      $('#delete-btn').click(function() {
        const ids = $('.row_chk:checked').map((_, el) => $(el).data('id')).get();
        if (ids.length == 0) return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");

        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          $.ajax({
            url: '/api/delete',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids }),
            success: loadList
          });
        }
      });

      /*$('#upload_btn').click(function() {
        $('#upload_modal').show();
      });
    */
      $('#confirm_upload').click(function() {
        const formData = new FormData();
        const files = $('#upload_files')[0].files;
        const stdDate = $('#upload_std_date').val().replace(/-/g, '');
        formData.append('std_date', stdDate);
        for (let f of files) formData.append('files', f);

        $.ajax({
          url: '/upload',
          type: 'POST',
          data: formData,
          contentType: false,
          processData: false,
          success: function() {
            alert("ì—…ë¡œë“œ ì™„ë£Œ");
            $('#upload_modal').hide();
            loadList();
          }
        });
      });
    });
// ì¸ë„¤ì¼ í´ë¦­ ì‹œ ì „ì²´ ì´ë¯¸ì§€ ë³´ê¸°
$(document).on('click', '.thumbnail', function () {
  const fullSrc = $(this).data('full');
  $('#modal-img').attr('src', fullSrc);
  $('#image-modal').fadeIn();
});

// ëª¨ë‹¬ í´ë¦­ ì‹œ ë‹«ê¸°
$('#image-modal').click(function () {
  $(this).fadeOut();
});    
  </script>
</body>
</html>