{% extends "base.html" %}

{% block title %}ë¶„ë¥˜ í†µê³„ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<!-- Hero ì˜ì—­: ë°°ê²½ ì´ë¯¸ì§€ë§Œ ê°€ë“ ì°¨ê²Œ -->
<div class="main-hero">
  <div class="hero-overlay">
    <h1>X-Ray ì´ë¬¼ì§ˆ ê²€ì¶œ ëŒ€ì‹œë³´ë“œ</h1>
    <p>ìŠ¤í¬ë¡¤í•´ì„œ í†µê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
  </div>
</div>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h2>ì´ë¯¸ì§€ ë¶„ë¥˜ í†µê³„</h2>
    </div>

<div class="dashboard-grid">
    <!-- 20250813 ì´ë„ì—° ìˆ˜ì • ì‹œì‘ (ê¸°ê°„ ì„ íƒê³¼ ì‹¤ì‹œê°„ ê²€ì‚¬ í˜„í™© ìˆœì„œ ë°”ê¿ˆ.) -->
    <div class="chart-container large flex-row">
        <div id="realtime-status">
            <h3>ì‹¤ì‹œê°„ ê²€ì‚¬ í˜„í™©</h3>
            <p>ì´ ê²€ì‚¬: <span id="total-scans">...</span> | ì •ìƒ: <span id="total-good">...</span> | <span style="color:red;">ë¶ˆëŸ‰: <span id="total-bad">...</span></span></p>
        </div>
        <canvas id="overallChart"></canvas>
    </div>

    <div class="dashboard-controls">
        <span>ê¸°ê°„ ì„ íƒ : </span>
        <input type="text" id="start_date_dash" readonly> ~ 
        <input type="text" id="end_date_dash" readonly>
        <button id="search_btn_dash">ì¡°íšŒ</button>
    </div>
    <!-- 20250813 ì´ë„ì—° ìˆ˜ì • ë -->
    
    <div class="chart-section daily-section"><div class="chart-container"><canvas id="dailyChart"></canvas></div></div>
    <div class="chart-section weekly-section"><div class="chart-container"><canvas id="weeklyChart"></canvas></div></div>
    <div class="chart-section monthly-section"><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
    <div class="chart-section score-section"><div class="chart-container"><canvas id="scoreChart"></canvas></div></div>
    <div class="chart-section reclass-section"><div class="chart-container"><canvas id="reclassChart"></canvas></div></div>
</div>
</div>
<script>
$(function() {
    let chartInstances = {}; // ëª¨ë“  ì°¨íŠ¸ ê°ì²´ë¥¼ ê´€ë¦¬

    // --- ì°¨íŠ¸ ë Œë”ë§/ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
    function renderOrUpdateChart(canvasId, chartConfig) {
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }
        const ctx = document.getElementById(canvasId).getContext('2d');
        chartInstances[canvasId] = new Chart(ctx, chartConfig);
    }

    // --- ë°ì´í„° íŒ¨ì¹­ ë° ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜ë“¤ ---
    function fetchAndRender(url, canvasId, title, labelKey, params = {}) {
        $.getJSON(url, params, function(data) {
            const labels = data.map(d => d[labelKey]);
            const good = data.map(d => d.good_count || d.ok_count || 0);
            const bad = data.map(d => d.bad_count || d.ng_count || 0);
            const rate = data.map(d => d.bad_rate || d.ng_rate || 0);
            
            renderOrUpdateChart(canvasId, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ì •ìƒ', data: good, backgroundColor: 'green' },
                        { label: 'ë¶ˆëŸ‰', data: bad, backgroundColor: 'red' },
                        { label: 'ë¶ˆëŸ‰ë¥ (%)', data: rate, type: 'line', borderColor: 'blue', yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, devicePixelRatio: window.devicePixelRatio * 1.5,
                    plugins: { title: { display: true, text: title, font: { size: 16 } } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'ê±´ìˆ˜' } },
                        y1: { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: 'ë¶ˆëŸ‰ë¥ (%)' } }
                    }
                }
            });
        });
    }

    function updateOverallStatus() {
        $.getJSON('/stats/overall', function(data) {
            $('#total-scans').text(data.total_count || 0);
            $('#total-bad').text(data.bad_count || 0);
            $('#total-good').text(data.good_count || 0);
            
            renderOrUpdateChart('overallChart', {
                type: 'doughnut',
                data: {
                    labels: ['ì •ìƒ (GOOD)', 'ë¶ˆëŸ‰ (BAD)'],
                    datasets: [{
                        data: [data.good_count, data.bad_count],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderColor: '#fff', borderWidth: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, devicePixelRatio: window.devicePixelRatio * 1.5,
                    plugins: {
                        title: { display: true, text: 'ğŸ“ˆ ì „ì²´ ì •í’ˆ/ë¶ˆëŸ‰ ë¹„ìœ¨', font: { size: 16 } },
                        legend: { position: 'bottom' }
                    }
                }
            });
        });
    }

    function renderScoreChart() {
        $.getJSON('/stats/score_distribution', data => {
            const labels = data.map(d => d.score);
            const counts = data.map(d => d.count);
        
            /*
            let cumulative = 0;
            const cumulativeCounts = counts.map(c => cumulative += c);

            renderOrUpdateChart('scoreChart', {
                type: 'bar',  // ê¸°ë³¸ì€ barë¡œ ë‘ê³  ë¼ì¸ë§Œ ë”°ë¡œ ì§€ì •
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'ê°œë³„ ê±´ìˆ˜',
                            data: counts,
                            backgroundColor: '#ffc107',
                            yAxisID: 'y',
                        },
                        {
                            type: 'line',
                            label: 'ëˆ„ì  ê±´ìˆ˜',
                            data: cumulativeCounts,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ“Š ê°œë³„ ê±´ìˆ˜ + ëˆ„ì  ê±´ìˆ˜ (í˜¼í•© ì°¨íŠ¸)',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Score' }
                        },
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: { display: true, text: 'ê°œë³„ ê±´ìˆ˜' }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'ëˆ„ì  ê±´ìˆ˜' }
                        }
                    }
                }
            });
        */
            
            renderOrUpdateChart('scoreChart', {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'íŒë³„ ê±´ìˆ˜', data: counts, backgroundColor: '#ffc107' }] },
                options: { responsive: true, maintainAspectRatio: false, devicePixelRatio: window.devicePixelRatio * 1.5, plugins: { title: { display: true, text: 'ğŸ§  ëª¨ë¸ ì‹ ë¢°ë„(Score) ë¶„í¬', font: { size: 16 } } }, scales: { y: { beginAtZero: true, title: { text: 'ê±´ìˆ˜' } } } }
            });
            
        });        
    }
    
    function renderReclassChart() {
        $.getJSON('/stats/reclassification_trend', data => {
            const labels = data.map(d => d.std_date);
            const counts = data.map(d => d.re_count);
            renderOrUpdateChart('reclassChart', {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'ìˆ˜ì • ê±´ìˆ˜', data: counts, borderColor: '#6f42c1', fill: false }] },
                options: { responsive: true, maintainAspectRatio: false, devicePixelRatio: window.devicePixelRatio * 1.5, plugins: { title: { display: true, text: 'âœï¸ ì¼ê°„ ì¬ë¶„ë¥˜ íšŸìˆ˜', font: { size: 16 } } }, scales: { y: { beginAtZero: true, title: { text: 'ê±´ìˆ˜' } } } }
            });
        });
    }
    
    function updateDashboardCharts() {
        const params = {
            start_date: $('#start_date_dash').val(),
            end_date: $('#end_date_dash').val()
        };
        fetchAndRender('/stats/daily', 'dailyChart', 'ğŸ“† ì¼ê°„ í†µê³„', 'std_date', params);
        fetchAndRender('/stats/weekly', 'weeklyChart', 'ğŸ“… ì£¼ê°„ í†µê³„', 'week_label'); // ì£¼ê°„/ì›”ê°„ì€ ì•„ì§ ê¸°ê°„ì¡°íšŒ ë¯¸ì ìš©
        fetchAndRender('/stats/monthly', 'monthlyChart', 'ğŸ—“ï¸ ì›”ê°„ í†µê³„', 'year_months');
    }
    
    // --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
    $("#start_date_dash, #end_date_dash").datepicker({ dateFormat: 'yy-mm-dd', maxDate: 0 });
    const today = new Date();
    const aMonthAgo = new Date();
    aMonthAgo.setMonth(today.getMonth() - 1);
    $("#start_date_dash").datepicker("setDate", aMonthAgo);
    $("#end_date_dash").datepicker("setDate", today);

    $('#search_btn_dash').click(updateDashboardCharts);
    
    updateOverallStatus();
    setInterval(updateOverallStatus, 10000);
    
    updateDashboardCharts();
    renderScoreChart();
    renderReclassChart();
});
</script>
{% endblock %}