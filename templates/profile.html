{% extends "base.html" %}

{% block title %}ê³„ì • ê´€ë¦¬{% endblock %}

{% block content %}
<div class="auth-container">
    <h2>ê³„ì • ê´€ë¦¬</h2>
    <p>íšŒì› ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <form method="POST" action="{{ url_for('profile') }}" id="profile-form">
        <div class="form-group">
            <label for="userid">ì•„ì´ë””</label>
            <input type="text" id="userid" name="userid" value="{{ current_user.username }}" readonly>
        </div>
        <div class="form-group">
            <label for="name">ì´ë¦„</label>
            <!-- ğŸ‘‡ user_dataê°€ ìˆìœ¼ë©´ ê·¸ ê°’ì„, ì—†ìœ¼ë©´ current_user ê°’ì„ ì‚¬ìš© -->
            <input type="text" id="name" name="name" value="{{ user_data.name or current_user.name }}" required>
            <div class="feedback-message"></div>
        </div>
        <div class="form-group">
            <label for="email">ì´ë©”ì¼</label>
            <input type="email" id="email" name="email" value="{{ user_data.email or current_user.email }}" required>
            <div class="feedback-message"></div>
        </div>
        <div class="form-group">
            <label for="company">ì†Œì† ê¸°ê´€/íšŒì‚¬ (ì„ íƒ)</label>
            <input type="text" id="company" name="company" value="{{ user_data.company or current_user.company or '' }}">
        </div>
        <div class="form-group">
            <label for="role">ì§ë¬´ ë˜ëŠ” ì—­í•  (ì„ íƒ)</label>
            <input type="text" id="role" name="role" value="{{ user_data.role or current_user.role or '' }}" placeholder="ì˜ˆ: í’ˆì§ˆ ê´€ë¦¬, ë°ì´í„° ë¶„ì„ê°€">
        </div>

        <hr class="form-divider">
        
        <h3 class="form-section-title">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (ì„ íƒ)</h3>
        <p class="form-section-desc">ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ë ¤ë©´ ì•„ë˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>

        <div class="form-group">
            <label for="current_password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="current_password" name="current_password">
            <div id="current-password-feedback" class="feedback-message"></div>
        </div>
        <div class="form-group">
            <label for="new_password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="new_password" name="new_password" placeholder="8~16ì">
            <div id="new-password-length-feedback" class="feedback-message"></div>
        </div>
        <div class="form-group">
            <label for="confirm_new_password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="confirm_new_password" name="confirm_new_password">
            <div id="new-password-feedback" class="feedback-message"></div>
        </div>

        <button type="submit" class="auth-btn">ì •ë³´ ìˆ˜ì •</button>
    </form>
    <hr class="form-divider">
    <div class="delete-account-section">
        <p>ê³„ì •ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <form id="delete-account-form" method="POST" action="{{ url_for('delete_account') }}">
            <button type="button" id="delete-account-btn" class="btn-delete">íšŒì› íƒˆí‡´</button>
        </form>
    </div>
</div>

<script>
$(function() {
    // --- ìœ íš¨ì„± ê²€ì‚¬ ìƒíƒœ í”Œë˜ê·¸ ---
    let isCurrentPasswordValid = false;
    let isNewPasswordLengthValid = false;
    let isNewPasswordDifferent = false; // âœ¨ [ìƒˆ í”Œë˜ê·¸] ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ í˜„ì¬ì™€ ë‹¤ë¥¸ì§€ ì—¬ë¶€
    let isNewPasswordMatch = false;
    let passwordCheckTimeout;

    // âœ¨ [ìƒˆ í”Œë˜ê·¸] ì´ë¦„ê³¼ ì´ë©”ì¼ ìœ íš¨ì„± í”Œë˜ê·¸ ì¶”ê°€
    let isNameValid = true; // í˜ì´ì§€ ë¡œë“œ ì‹œì—ëŠ” ê¸°ì¡´ ê°’ì´ ìœ íš¨í•˜ë‹¤ê³  ê°€ì •
    let isEmailValid = true; // í˜ì´ì§€ ë¡œë“œ ì‹œì—ëŠ” ê¸°ì¡´ ê°’ì´ ìœ íš¨í•˜ë‹¤ê³  ê°€ì •

    // --- 1. ì‹¤ì‹œê°„ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    $('#current_password').on('input', function() {
        const password = $(this).val();
        const feedback = $('#current-password-feedback');
        clearTimeout(passwordCheckTimeout);

        if (password.length === 0) {
            feedback.text('');
            isCurrentPasswordValid = false;
            return;
        }
        passwordCheckTimeout = setTimeout(() => {
            $.ajax({
                url: '/check_current_password', type: 'POST',
                contentType: 'application/json', data: JSON.stringify({ password: password }),
                success: function(response) {
                    if (response.valid) {
                        feedback.text('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.').removeClass('unavailable').addClass('available');
                        isCurrentPasswordValid = true;
                    } else {
                        feedback.text('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
                        isCurrentPasswordValid = false;
                    }
                }
            });
        }, 500);
    });

    // --- 2. ì‹¤ì‹œê°„ ìƒˆ ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬ (âœ¨ ìˆ˜ì •ëœ ë¶€ë¶„) ---
    // 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸' ë˜ëŠ” 'ìƒˆ ë¹„ë°€ë²ˆí˜¸' ì…ë ¥ ì‹œ ëª¨ë‘ ê²€ì‚¬ ì‹¤í–‰
    $('#current_password, #new_password').on('input', function() {
        const currentPassword = $('#current_password').val();
        const newPassword = $('#new_password').val();
        const length = newPassword.length;
        const feedback = $('#new-password-length-feedback');
        
        isNewPasswordDifferent = false; // ì¼ë‹¨ falseë¡œ ì´ˆê¸°í™”

        if (length === 0) {
            feedback.text('');
            isNewPasswordLengthValid = false;
        } else if (length < 8) {
            feedback.text('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isNewPasswordLengthValid = false;
        } else if (length > 16) {
            feedback.text('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 16ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isNewPasswordLengthValid = false;
        // âœ¨ [í•µì‹¬ ì¶”ê°€] ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë™ì¼í•œì§€ ê²€ì‚¬
        } else if (currentPassword.length > 0 && newPassword === currentPassword) {
            feedback.text('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isNewPasswordLengthValid = false; // ê¸¸ì´ ì¡°ê±´ì€ ë§ì§€ë§Œ, ì „ì²´ì ìœ¼ë¡œëŠ” ìœ íš¨í•˜ì§€ ì•ŠìŒ
        } else {
            feedback.text('ì‚¬ìš© ê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.').removeClass('unavailable').addClass('available');
            isNewPasswordLengthValid = true;
            isNewPasswordDifferent = true; // ëª¨ë“  ê²€ì¦ì„ í†µê³¼í•´ì•¼ true
        }
    });

    // --- 3. ì‹¤ì‹œê°„ ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    $('#new_password, #confirm_new_password').on('input', function() {
        const newPassword = $('#new_password').val();
        const confirmPassword = $('#confirm_new_password').val();
        const feedback = $('#new-password-feedback');
        if (confirmPassword === '') {
            feedback.text(''); isNewPasswordMatch = false; return;
        }
        if (newPassword === confirmPassword) {
            feedback.text('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.').removeClass('unavailable').addClass('available');
            isNewPasswordMatch = true;
        } else {
            feedback.text('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isNewPasswordMatch = false;
        }
    });

    // --- âœ¨ [ìƒˆë¡œ ì¶”ê°€] ì´ë¦„ í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬ ---
    // register.htmlì˜ ë¡œì§ê³¼ ë™ì¼
    $('#name').on('input focusout', function(event) {
        const name = $(this).val();
        const feedback = $(this).siblings('.feedback-message');
        const nameRegex = /^\p{L}+$/u;

        if (name === '') {
            if (event.type === 'focusout') {
                feedback.text('ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            } else {
                feedback.text('');
            }
            isNameValid = false;
            return;
        }
        if (nameRegex.test(name)) {
            feedback.text('');
            isNameValid = true;
        } else {
            feedback.text('ì´ë¦„ì€ ë¬¸ìë¡œë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì, ê³µë°± ì œì™¸)').removeClass('available').addClass('unavailable');
            isNameValid = false;
        }
    });

    // --- âœ¨ [ìƒˆë¡œ ì¶”ê°€] ì´ë©”ì¼ í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬ ---
    // register.htmlì˜ ë¡œì§ê³¼ ë™ì¼
    $('#email').on('input focusout', function(event) {
        const email = $(this).val();
        const feedback = $(this).siblings('.feedback-message');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (email === '') {
            if (event.type === 'focusout') {
                feedback.text('ì´ë©”ì¼ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            } else {
                feedback.text('');
            }
            isEmailValid = false;
            return;
        }
        if (emailRegex.test(email)) {
            feedback.text('');
            isEmailValid = true;
        } else {
            feedback.text('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isEmailValid = false;
        }
    });

    // --- 4. í¼ ì œì¶œ ì‹œ ìµœì¢… ìœ íš¨ì„± ê²€ì‚¬ (âœ¨ ìˆ˜ì •ëœ ë¶€ë¶„) ---
    $('#profile-form').on('submit', function(event) {
        if ($('#current_password').val() || $('#new_password').val() || $('#confirm_new_password').val()) {
            if (!isCurrentPasswordValid) {
                alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                event.preventDefault(); return;
            }
            if (!isNewPasswordLengthValid) {
                alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, 16ì ì´í•˜ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                event.preventDefault(); return;
            }
            // âœ¨ [í•µì‹¬ ì¶”ê°€] ìµœì¢… ì œì¶œ ì‹œì—ë„ í•œë²ˆ ë” í™•ì¸
            if (!isNewPasswordDifferent) {
                alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¤ë¥´ê²Œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.');
                event.preventDefault(); return;
            }
            if (!isNewPasswordMatch) {
                alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                event.preventDefault(); return;
            }
        }

        // [í•µì‹¬ ì¶”ê°€] ì´ë¦„ê³¼ ì´ë©”ì¼ í•„ë“œ ìµœì¢… ê²€ì‚¬
        if ($('#name').val() === '' || !isNameValid) {
            alert('ì´ë¦„ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            event.preventDefault(); return;
        }
        if ($('#email').val() === '' || !isEmailValid) {
            alert('ì´ë©”ì¼ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            event.preventDefault(); return;
        }
    });

    // --- íšŒì› íƒˆí‡´ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ---
    $('#delete-account-btn').on('click', function() {
        // ì‚¬ìš©ìì—ê²Œ ì¬í™•ì¸
        if (confirm('ì •ë§ë¡œ íšŒì›ì—ì„œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì •ë³´ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.')) {
            // í™•ì¸ ì‹œ í¼ì„ ì œì¶œ
            $('#delete-account-form').submit();
        }
    });
});
</script>
{% endblock %}