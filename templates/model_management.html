{% extends "base.html" %}
{% block title %}ëª¨ë¸ ê´€ë¦¬{% endblock %}

{% block head %}
<style>
    #retraining-log { background-color: #222; color: #0f0; padding: 15px; border-radius: 5px; height: 400px; overflow-y: scroll; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; border: 1px solid #444; }
    .status-badge { padding: 2px 12px; border-radius: 12px; color: white; font-weight: bold; line-height: 1.5; }
    .status-pending { background-color: #6c757d; } .status-running { background-color: #007bff; } .status-completed { background-color: #28a745; }
    .status-failed { background-color: #dc3545; } .status-canceled { background-color: #ffc107; color: #212529; }
    .retraining-status-section p { margin-bottom: 10px; }
    .job-history-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    .job-history-table th, .job-history-table td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 0.9em;}
    .job-history-table th { background-color: #f8f9fa; }
    .job-history-filters { margin-top: 20px; padding: 15px; background-color: #f1f3f5; border: 1px solid #dee2e6; border-radius: 5px; display: flex; gap: 10px; align-items: center; }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <h2>ëª¨ë¸ ê´€ë¦¬</h2>
    <p>ìš´ì˜ìê°€ ì¬ë¶„ë¥˜í•œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª¨ë¸ì„ ì¬í•™ìŠµí•˜ì—¬ ì„±ëŠ¥ì„ ê°œì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <hr class="form-divider" style="margin: 20px 0;">

    <!-- 1. ì¬í•™ìŠµ ì‹¤í–‰ ì˜ì—­ -->
    <div class="model-management-section">
        <h3>ì§€ë„í•™ìŠµ ëª¨ë¸ (YOLO) ì¬í•™ìŠµ</h3>
        <p style="margin-bottom: 20px;">
            <strong>í˜„ì¬ ì¬í•™ìŠµì— ë°˜ì˜ë  ì¬ë¶„ë¥˜ ì´ë¯¸ì§€ëŠ” ì´ <span style="color: #007bff;">{{ reclassified_count }}</span>ê°œ ì…ë‹ˆë‹¤.</strong>
        </p>
        <div id="retrain-controls">
            <form action="{{ url_for('retrain_model') }}" method="POST" style="display: inline-block;" onsubmit="return confirm('ëª¨ë¸ ì¬í•™ìŠµì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                <button type="submit" id="retrain-btn" class="btn-promote" style="padding: 10px 20px; font-size: 1.1rem;">ëª¨ë¸ ì¬í•™ìŠµ ì‹œì‘</button>
            </form>
        </div>
    </div>
    <hr class="form-divider" style="margin: 40px 0;">

    <!-- 2. í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‘ì—… í‘œì‹œ ì˜ì—­ (ë™ì ìœ¼ë¡œ í‘œì‹œ/ìˆ¨ê¹€) -->
    <div id="live-status-container" class="retraining-status-section" style="display: none;">
        <h3>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‘ì—…</h3>
        <p><strong>ìƒíƒœ:</strong> <span id="job-status" class="status-badge"></span></p>
        <p><strong>ìµœì¢… ê²°ê³¼:</strong> <span id="job-result"></span></p>
        <p><strong>ë¡œê·¸:</strong></p>
        <pre id="retraining-log"></pre>
    </div>

    <!-- 3. ì¬í•™ìŠµ ì´ë ¥ ëª©ë¡ -->
    <div class="job-history-section">
        <h3>ì¬í•™ìŠµ ì´ë ¥</h3>
        <!-- ë‚ ì§œ ê²€ìƒ‰ í•„í„° -->
        <div class="job-history-filters">
            <span>ì¡°íšŒ ê¸°ê°„:</span>
            <input type="date" id="from_date" value="{{ from_date or '' }}">
            <span>~</span>
            <input type="date" id="to_date" value="{{ to_date or '' }}">
            <button id="filter-btn">ì¡°íšŒ</button>
        </div>

        <table class="job-history-table">
            <thead>
                <tr>
                    <th>ì‘ì—… ID</th><th>ìƒíƒœ</th><th>ê²°ê³¼</th><th>ì‹œì‘ ì‹œê°„</th><th>ì™„ë£Œ ì‹œê°„</th><th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                {% for job in job_history %}
                <tr>
                    <td>{{ job.id }}</td>
                    <td><span class="status-badge status-{{ job.status.lower() }}">{{ job.status }}</span></td>
                    <td>{{ job.result_message or '-' }}</td>
                    <td>{{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') if job.completed_at else '-' }}</td>
                    <td>
                        <button class="btn-delete delete-job-btn" data-job-id="{{ job.id }}">ì‚­ì œ</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6">ì¬í•™ìŠµ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ -->
        <div id="pagination-controls" style="margin-top: 20px; text-align: center;"></div>
    </div>
</div>

<script>
$(document).ready(function() {
    let pollingInterval;
    // ğŸ’¡ [í•µì‹¬ ì¶”ê°€] ì´ì „ ì‘ì—… ìƒíƒœë¥¼ ê¸°ì–µí•˜ê¸° ìœ„í•œ ë³€ìˆ˜
    let lastKnownStatus = null;

    // --- 1. í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‘ì—… ìƒíƒœ í´ë§ ---
    function checkRetrainingStatus() {
        $.getJSON('/api/retraining_status', function(job) {
            const currentStatus = job.status;

            // --- ğŸš€ [í•µì‹¬ ë¡œì§] ì‘ì—… ìƒíƒœê°€ 'ì§„í–‰ ì¤‘'ì—ì„œ 'ì™„ë£Œ/ì‹¤íŒ¨/ì·¨ì†Œ'ë¡œ ë°”ë€ŒëŠ” ìˆœê°„ì„ ê°ì§€ ---
            if ((lastKnownStatus === 'RUNNING' || lastKnownStatus === 'PENDING') && 
                (currentStatus === 'COMPLETED' || currentStatus === 'FAILED' || currentStatus === 'CANCELED')) {
                
                // 1. í´ë§ì„ ì¦‰ì‹œ ì¤‘ì§€
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }

                // 2. ê²°ê³¼ì— ë§ëŠ” í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
                let toastType = 'info';
                if (currentStatus === 'COMPLETED') toastType = 'success';
                if (currentStatus === 'FAILED') toastType = 'error';
                if (currentStatus === 'CANCELED') toastType = 'warning'; // CANCELEDëŠ” warning íƒ€ì…ìœ¼ë¡œ ì„¤ì •
                
                showToast(job.result_message || 'ì‘ì—…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', toastType);

                // 3. 2ì´ˆ í›„ì— í˜ì´ì§€ë¥¼ ì™„ì „íˆ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì´ë ¥ í…Œì´ë¸”ì„ ìµœì‹ í™”
                setTimeout(() => {
                    window.location.reload();
                }, 2000); // ì‚¬ìš©ìê°€ ì•Œë¦¼ì„ ì½ì„ ì‹œê°„ì„ 2ì´ˆ ì¤ë‹ˆë‹¤.

                return; // í•¨ìˆ˜ë¥¼ ì—¬ê¸°ì„œ ì¢…ë£Œí•˜ì—¬ ì•„ë˜ ë¡œì§ì„ íƒ€ì§€ ì•Šë„ë¡ í•¨
            }
            
            // ì´ì „ ìƒíƒœë¥¼ í˜„ì¬ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
            lastKnownStatus = currentStatus;

            // --- ê¸°ì¡´ì˜ ì‹¤ì‹œê°„ UI ì—…ë°ì´íŠ¸ ë¡œì§ (ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ ì‹¤í–‰) ---
            const liveContainer = $('#live-status-container');
            const retrainBtn = $('#retrain-btn');
            const controlsContainer = $('#retrain-controls');

            if (currentStatus === 'RUNNING' || currentStatus === 'PENDING') {
                liveContainer.show();
                $('#job-status').text(currentStatus).removeClass().addClass('status-badge status-' + currentStatus.toLowerCase());
                $('#retraining-log').text(job.progress_log || '').scrollTop($('#retraining-log')[0].scrollHeight);
                $('#job-result').text(job.result_message || 'ì§„í–‰ ì¤‘...');
                
                retrainBtn.prop('disabled', true).text('ì¬í•™ìŠµ ì§„í–‰ ì¤‘...');
                if (controlsContainer.find('#stop-btn').length === 0) {
                    controlsContainer.append('<button type="button" id="stop-btn" class="btn-delete" style="padding: 10px 20px; font-size: 1.1rem; margin-left: 10px;">ê°•ì œ ì¤‘ì§€</button>');
                }
                if (!pollingInterval) {
                   pollingInterval = setInterval(checkRetrainingStatus, 5000);
                }
            } else {
                liveContainer.hide();
                retrainBtn.prop('disabled', false).text('ëª¨ë¸ ì¬í•™ìŠµ ì‹œì‘');
                controlsContainer.find('#stop-btn').remove();
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
            }
        }).fail(function() {
            $('#retraining-log').text('ì„œë²„ì—ì„œ ìƒíƒœ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        });
    }

    // --- 2. ì¬í•™ìŠµ ì´ë ¥ í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§ ---
    function renderPagination() {
        const totalItems = {{ total_jobs }};
        const itemsPerPage = {{ per_page }};
        const currentPage = {{ page }};
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        // ... (list.htmlì˜ renderPagination ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ êµ¬í˜„) ...
        const controls = $('#pagination-controls').empty();
        if (totalPages <= 1) return;
        let paginationHtml = '<ul class="pagination">';
        paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage - 1}">ì´ì „</a></li>`;
        for (let i = 1; i <= totalPages; i++) {
            paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }
        paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage + 1}">ë‹¤ìŒ</a></li>`;
        paginationHtml += '</ul>';
        controls.html(paginationHtml);
    }

    // --- 3. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    // ê°•ì œ ì¤‘ì§€
    $(document).on('click', '#stop-btn', function() {
        if (confirm('ì •ë§ë¡œ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì¬í•™ìŠµì„ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            $.post('/api/stop_retraining', function(response) {
                showToast(response.message, response.status);
                // ì¦‰ì‹œ ìƒíƒœë¥¼ ë‹¤ì‹œ í•œë²ˆ ì²´í¬
                checkRetrainingStatus();
            }).fail(function(xhr) {
                showToast(xhr.responseJSON.message || 'ì‘ì—… ì¤‘ì§€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            });
        }
    });
    // ì´ë ¥ ì‚­ì œ
    $(document).on('click', '.delete-job-btn', function() {
        const jobId = $(this).data('job-id');
        if (confirm(`ì‘ì—… ID ${jobId} ì´ë ¥ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
            $.post(`/api/delete_job/${jobId}`, function(response) {
                showToast(response.message, response.status);
                // ğŸ’¡ [í•µì‹¬ ìˆ˜ì •] 1.5ì´ˆ í›„ì— í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬
                //    ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì½ì„ ì‹œê°„ì„ ì¤ë‹ˆë‹¤.
                setTimeout(() => {
                    window.location.reload();
                }, 1500); 
            }).fail(function(xhr) {
                showToast(xhr.responseJSON.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            });
        }
    });
    // ë‚ ì§œ í•„í„° ì¡°íšŒ
    $('#filter-btn').on('click', function() {
        const fromDate = $('#from_date').val();
        const toDate = $('#to_date').val();
        window.location.href = `/admin/model?from_date=${fromDate}&to_date=${toDate}`;
    });
    // í˜ì´ì§€ë„¤ì´ì…˜ í´ë¦­
    $(document).on('click', '.pagination a', function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        if(page){
            const fromDate = $('#from_date').val();
            const toDate = $('#to_date').val();
            window.location.href = `/admin/model?page=${page}&from_date=${fromDate}&to_date=${toDate}`;
        }
    });

    // --- 4. ì´ˆê¸°í™” ---
    checkRetrainingStatus();
    renderPagination();
});
</script>
{% endblock %}