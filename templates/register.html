{% extends "base.html" %}

{% block title %}íšŒì›ê°€ì…{% endblock %}

{% block content %}
<div class="auth-container">
    <h2>íšŒì›ê°€ì…</h2>
    <p>ì‚¬ìš©í•  ê³„ì • ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>

    <form method="POST" action="{{ url_for('register') }}" id="register-form" novalidate>
        <div class="form-group form-group-inline">
            <div class="input-wrapper">
                <label for="userid">ì•„ì´ë””</label>
                <input type="text" id="userid" name="userid" placeholder="4ì ì´ìƒ" required minlength="4">
            </div>
            <button type="button" id="check-userid-btn">ì¤‘ë³µ í™•ì¸</button>
        </div>
        <div id="userid-feedback" class="feedback-message"></div>

        <div class="form-group">
            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="password" name="password" placeholder="8~16ì ì…ë ¥" required>
            <!-- ì‹¤ì‹œê°„ ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ í”¼ë“œë°±ì„ ìœ„í•œ ìš”ì†Œ -->
            <div id="password-length-feedback" class="feedback-message"></div>
        </div>
        <div class="form-group">
            <label for="password_confirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="password_confirm" name="password_confirm" required>
            <div id="password-feedback" class="feedback-message"></div>
        </div>

        <hr class="form-divider">

        <div class="form-group">
            <label for="name">ì´ë¦„</label>
            <input type="text" id="name" name="name" required>
            <div class="feedback-message"></div>
        </div>
        <div class="form-group">
            <label for="email">ì´ë©”ì¼</label>
            <input type="email" id="email" name="email" required>
            <div id="email-feedback" class="feedback-message"></div>
        </div>
        <div class="form-group">
            <label for="company">ì†Œì† ê¸°ê´€/íšŒì‚¬ (ì„ íƒ)</label>
            <input type="text" id="company" name="company">
        </div>
        <div class="form-group">
            <label for="role">ì§ë¬´ ë˜ëŠ” ì—­í•  (ì„ íƒ)</label>
            <input type="text" id="role" name="role" placeholder="ì˜ˆ: í’ˆì§ˆ ê´€ë¦¬, ë°ì´í„° ë¶„ì„ê°€">
        </div>
        <!-- [í•µì‹¬ ìˆ˜ì •] ê´€ë¦¬ì ì½”ë“œ ì…ë ¥ë€ê³¼ í”¼ë“œë°± ë©”ì‹œì§€ div -->
        <div class="form-group">
            <label for="admin_code">ê´€ë¦¬ì ì½”ë“œ (ì„ íƒ)</label>
            <input type="text" id="admin_code" name="admin_code" placeholder="ê´€ë¦¬ìë§Œ ì…ë ¥í•˜ì„¸ìš”">
            <div id="admin-code-feedback" class="feedback-message"></div>
        </div>
        
        <div class="form-group-terms">
            <input type="checkbox" id="terms" name="terms" required>
            <label for="terms">ì´ìš©ì•½ê´€ ë° ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
        </div>
        <div id="terms-feedback" class="feedback-message"></div>

        <button type="submit" class="auth-btn">íšŒì›ê°€ì…</button>
    </form>
    <div class="auth-switch">
        <p>ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="{{ url_for('login') }}">ë¡œê·¸ì¸</a></p>
    </div>
</div>

<script>
$(function() {
    // --- ìœ íš¨ì„± ê²€ì‚¬ ìƒíƒœë¥¼ ì €ì¥í•  í”Œë˜ê·¸ ë³€ìˆ˜ë“¤ ---
    let isUserIdAvailable = false;
    let isPasswordLengthValid = false; // ğŸ‘ˆ ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ ìœ íš¨ì„± í”Œë˜ê·¸ ì¶”ê°€
    let isPasswordMatch = false;
    let isEmailValid = false;
    let isNameValid = false; // âœ¨ [ìƒˆ í”Œë˜ê·¸] ì´ë¦„ ìœ íš¨ì„± í”Œë˜ê·¸
    let isEmailAvailable = false;   // ì´ë©”ì¼ ì¤‘ë³µ ìœ íš¨ì„± í”Œë˜ê·¸
    let emailCheckTimeout; // ì´ë©”ì¼ ë””ë°”ìš´ì‹± íƒ€ì´ë¨¸
    let adminCodeCheckTimeout; // ë””ë°”ìš´ì‹± íƒ€ì´ë¨¸

    // --- ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ ê·œì¹™ ì •ì˜ ---
    const MIN_PASSWORD_LENGTH = 8;
    const MAX_PASSWORD_LENGTH = 16;

    // --- 1. ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ (ê¸°ì¡´ê³¼ ë™ì¼) ---
    $('#check-userid-btn').on('click', function() {
        // ... (ê¸°ì¡´ ì½”ë“œ ìƒëµ) ...
        const userid = $('#userid').val();
        const feedback = $('#userid-feedback');
        if (userid.length < 4) {
            feedback.text('ì•„ì´ë””ëŠ” 4ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.').removeClass('available').addClass('unavailable');
            isUserIdAvailable = false; return;
        }
        $.ajax({
            url: '/check_userid', type: 'POST', contentType: 'application/json',
            data: JSON.stringify({ userid: userid }),
            success: function(response) {
                if (response.available) {
                    feedback.text('ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.').removeClass('unavailable').addClass('available');
                    isUserIdAvailable = true;
                } else {
                    feedback.text('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
                    isUserIdAvailable = false;
                }
            }
        });
    });
    $('#userid').on('input', function() {
        $('#userid-feedback').text(''); isUserIdAvailable = false;
    });
    // ì•„ì´ë”” í•„ë“œë¥¼ ë¹„ìš´ ì±„ë¡œ ë‹¤ë¥¸ ê³³ì„ í´ë¦­í–ˆì„ ë•Œì˜ ì²˜ë¦¬
    $('#userid').on('focusout', function() {
        const userid = $(this).val();
        if (userid === '') {
            $('#userid-feedback').text('ì•„ì´ë””ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isUserIdAvailable = false;
        }
    });

    // --- 2. ì‹¤ì‹œê°„ ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ ê²€ì‚¬ (âœ¨ ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„) ---
    $('#password').on('input focusout', function(event) {
        const password = $(this).val();
        const length = password.length;
        const feedback = $('#password-length-feedback');
        
        if (length === 0) {
            // focusout ì´ë²¤íŠ¸ì¼ ë•Œë§Œ "í•„ìˆ˜" ë©”ì‹œì§€ í‘œì‹œ
            if (event.type === 'focusout') {
                feedback.text('ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            } else {
                feedback.text('');
            }
            isPasswordLengthValid = false;
        } else if (length < 8) {
            feedback.text('ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isPasswordLengthValid = false;
        } else if (length > 16) {
            feedback.text('ë¹„ë°€ë²ˆí˜¸ëŠ” 16ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isPasswordLengthValid = false;
        } else {
            feedback.text('ì‚¬ìš© ê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.').removeClass('unavailable').addClass('available');
            isPasswordLengthValid = true;
        }
    });

    // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í•„ë“œì— ëŒ€í•œ focusout ì´ë²¤íŠ¸ë¥¼ ìƒˆë¡œ ì¶”ê°€
    $('#password_confirm').on('focusout', function() {
        if ($(this).val() === '' && $('#password').val() !== '') {
            $('#password-feedback').text('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isPasswordMatch = false;
        }
    });

    // --- 3. ì‹¤ì‹œê°„ ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ê²€ì‚¬ ---
    $('#password, #password_confirm').on('input', function() {
        const password = $('#password').val();
        const passwordConfirm = $('#password_confirm').val();
        const feedback = $('#password-feedback');

        if (passwordConfirm === '') {
            feedback.text(''); isPasswordMatch = false; return;
        }
        if (password === passwordConfirm) {
            feedback.text('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.').removeClass('unavailable').addClass('available');
            isPasswordMatch = true;
        } else {
            feedback.text('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isPasswordMatch = false;
        }
    });

    // --- 3. ì´ë¦„ í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬ (âœ¨ ì¤‘ë³µ ì œê±° ë° ì •ë¦¬ëœ ìµœì¢… ë²„ì „) ---
    $('#name').on('input focusout', function(event) {
        const name = $(this).val();
        const feedback = $(this).siblings('.feedback-message');
        const nameRegex = /^\p{L}+$/u;

        if (name === '') {
            if (event.type === 'focusout') {
                feedback.text('ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            } else {
                feedback.text('');
            }
            isNameValid = false;
            return;
        }
        if (nameRegex.test(name)) {
            feedback.text('');
            isNameValid = true;
        } else {
            feedback.text('ì´ë¦„ì€ ë¬¸ìë¡œë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì, ê³µë°± ì œì™¸)').removeClass('available').addClass('unavailable');
            isNameValid = false;
        }
    });

    // --- 4. ì‹¤ì‹œê°„ ì´ë©”ì¼ í˜•ì‹ ê²€ì‚¬ (âœ¨ focusout ì´ë²¤íŠ¸ ì¶”ê°€) ---
    $('#email').on('input focusout', function(event) {
        const email = $(this).val();
        const feedback = $('#email-feedback');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (email === '') {
            // focusout ì´ë²¤íŠ¸ì¼ ë•Œë§Œ "í•„ìˆ˜" ë©”ì‹œì§€ í‘œì‹œ
            if (event.type === 'focusout') {
                feedback.text('ì´ë©”ì¼ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            } else {
                feedback.text('');
            }
            isEmailValid = false;
            return;
        }

        if (emailRegex.test(email)) {
            feedback.text('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.').removeClass('unavailable').addClass('available');
            isEmailValid = true;
        } else {
            feedback.text('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isEmailValid = false;
        }
    });

    // --- 5. âœ¨ [í•µì‹¬ ìˆ˜ì •] ì‹¤ì‹œê°„ ì´ë©”ì¼ í˜•ì‹ ë° ì¤‘ë³µ ê²€ì‚¬ ---
    $('#email').on('input focusout', function(event) {
        const email = $(this).val();
        const feedback = $('#email-feedback');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        clearTimeout(emailCheckTimeout);

        if (email === '') {
            if (event.type === 'focusout') feedback.text('ì´ë©”ì¼ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            else feedback.text('');
            isEmailFormatValid = false;
            isEmailAvailable = false;
            return;
        }

        if (emailRegex.test(email)) {
            isEmailFormatValid = true;
            feedback.text('ì˜¬ë°”ë¥¸ í˜•ì‹ì…ë‹ˆë‹¤. ì¤‘ë³µ ì—¬ë¶€ë¥¼ í™•ì¸ ì¤‘...').removeClass('unavailable available');
            
            emailCheckTimeout = setTimeout(() => {
                $.ajax({
                    url: '/check_email', // ìƒˆë¡œ ë§Œë“  API í˜¸ì¶œ
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ email: email }),
                    success: function(response) {
                        if (response.available) {
                            feedback.text('ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤.').removeClass('unavailable').addClass('available');
                            isEmailAvailable = true;
                        } else {
                            feedback.text('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
                            isEmailAvailable = false;
                        }
                    }
                });
            }, 500);
        } else {
            feedback.text('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
            isEmailFormatValid = false;
            isEmailAvailable = false;
        }
    });

    // --- 6. ì‹¤ì‹œê°„ ê´€ë¦¬ì ì½”ë“œ í™•ì¸ ---
    $('#admin_code').on('input', function() {
        const code = $(this).val();
        const feedback = $('#admin-code-feedback');
        clearTimeout(adminCodeCheckTimeout); // ì´ì „ íƒ€ì´ë¨¸ ì·¨ì†Œ

        // ì…ë ¥ì°½ì´ ë¹„ì–´ìˆìœ¼ë©´ ë©”ì‹œì§€ ìˆ¨ê¹€
        if (code === '') {
            feedback.text('');
            return;
        }

        // 0.5ì´ˆ ë””ë°”ìš´ì‹±: íƒ€ì´í•‘ì´ ë©ˆì¶˜ í›„ 0.5ì´ˆ ë’¤ì— ì„œë²„ì— ìš”ì²­
        adminCodeCheckTimeout = setTimeout(() => {
            $.ajax({
                url: '/check_admin_code',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ admin_code: code }),
                success: function(response) {
                    if (response.valid) {
                        feedback.text('ê´€ë¦¬ì ì½”ë“œê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.').removeClass('unavailable').addClass('available');
                    } else {
                        feedback.text('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ê´€ë¦¬ì ì½”ë“œì…ë‹ˆë‹¤.').removeClass('available').addClass('unavailable');
                    }
                }
            });
        }, 500);
    });

    // --- 7. ìµœì¢… í¼ ì œì¶œ ì‹œ ìœ íš¨ì„± ê²€ì‚¬ ---
    $('#register-form').on('submit', function(event) {
        // ëª¨ë“  í•„ìˆ˜ í•„ë“œë¥¼ ë‹¤ì‹œ í•œë²ˆ ê²€ì‚¬í•˜ì—¬ í”¼ë“œë°±ì„ ê°•ì œë¡œ í‘œì‹œ
        if ($('#userid').val() === '') { $('#userid').trigger('focusout'); }
        if ($('#password').val() === '') { $('#password').trigger('focusout'); }
        if ($('#password_confirm').val() === '') { $('#password_confirm').trigger('focusout'); }
        if ($('#name').val() === '') { $('#name').trigger('focusout'); }
        if ($('#email').val() === '') { $('#email').trigger('focusout'); }
        
        let errorMessages = [];
        if (!isUserIdAvailable) { errorMessages.push('ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.'); }
        if (!isPasswordLengthValid) { errorMessages.push('ë¹„ë°€ë²ˆí˜¸ ê·œì¹™(8~16ì)ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'); }
        if (!isPasswordMatch) { errorMessages.push('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
        if (!isNameValid) { errorMessages.push('ì´ë¦„ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
        if (!isEmailFormatValid) { errorMessages.push('ì´ë©”ì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'); }
        else if (!isEmailAvailable) { errorMessages.push('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.'); } // í˜•ì‹ì€ ë§ì§€ë§Œ ì¤‘ë³µëœ ê²½ìš°
        
        // âœ¨ ì´ìš©ì•½ê´€ ì²´í¬ëŠ” ë³„ë„ë¡œ ì²˜ë¦¬
        let isTermsChecked = true;
        if (!$('#terms').is(':checked')) {
            $('#terms-feedback').text('ì´ìš©ì•½ê´€ì— ë™ì˜í•´ì•¼ í•©ë‹ˆë‹¤.').addClass('unavailable');
            isTermsChecked = false;
        }

        // âœ¨ alertë¥¼ ë„ìš¸ ì˜¤ë¥˜ê°€ ìˆê±°ë‚˜, ì´ìš©ì•½ê´€ì— ë™ì˜í•˜ì§€ ì•Šì•˜ìœ¼ë©´ ì œì¶œì„ ë§‰ìŒ
        if (errorMessages.length > 0 || !isTermsChecked) {
            event.preventDefault(); // í¼ ì œì¶œ ì¤‘ë‹¨

            // âœ¨ errorMessages ë°°ì—´ì— ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ alertë¥¼ ë„ì›€
            if (errorMessages.length > 0) {
                alert(errorMessages.join('\n'));
            }
        }
    });

    $('#terms').on('change', function() {
        if ($(this).is(':checked')) {
            $('#terms-feedback').text('').removeClass('unavailable');
        }
    });
});
</script>
{% endblock %}